<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å®¹é‡æ¸¬å®š & ç”»åƒåœ§ç¸®ãƒ„ãƒ¼ãƒ«</title>

<style>
body {
  font-family: sans-serif;
  background:#f4f4f4;
  padding:20px;
}

h2,h3 { margin-top:0; }

#fileBox {
  border:2px dashed #888;
  background:#fff;
  height:220px;
  padding:15px;
  overflow:auto;
  font-size:14px;
}

.fileItem {
  padding:6px 0;
  border-bottom:1px solid #eee;
}

button {
  padding:14px 22px;
  font-size:16px;
  margin:10px 5px 10px 0;
  cursor:pointer;
}

input[type="range"] {
  width:100%;
  height:32px;
}

.previewRow {
  display:flex;
  gap:30px;
  margin-top:20px;
}

.imageBox {
  text-align:center;
}

.imageBox img {
  width:260px;   /* è¡¨ç¤ºã‚µã‚¤ã‚ºå›ºå®š */
  border-radius:6px;
  cursor:pointer;
  background:#eee;
}

small { color:#666; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
#modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

#modal img {
  max-width:90%;
  max-height:90%;
  border-radius:8px;
}

</style>
</head>

<body>

<h2>å®¹é‡æ¸¬å®š & ç”»åƒåœ§ç¸®</h2>

<input type="file" id="fileInput" multiple><br><br>

<div id="fileBox">ã“ã“ã«ç”»åƒãƒ»å‹•ç”»ãƒ»æ›¸é¡ã‚’è²¼ã‚Šä»˜ã‘</div>

<button id="measureBtn">å®¹é‡æ¸¬å®š</button>
<div id="sizeResult"></div>

<hr>

<h3>ç”»åƒåœ§ç¸®</h3>

<label>å¹…ï¼š<span id="pxValue">800</span> px</label>
<input type="range" id="pxRange" min="100" max="1200" step="50" value="800">

<button id="compressBtn">åœ§ç¸®</button>

<div id="compressResult"></div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal">
  <img id="modalImg">
</div>

<script>
let files = [];

const fileBox = document.getElementById("fileBox");
const fileInput = document.getElementById("fileInput");
const sizeResult = document.getElementById("sizeResult");
const compressResult = document.getElementById("compressResult");
const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");

/* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ */
fileInput.addEventListener("change", e => {
  files = [...e.target.files];
  renderFiles();
});

/* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— */
fileBox.addEventListener("dragover", e => e.preventDefault());
fileBox.addEventListener("drop", e => {
  e.preventDefault();
  files = [...e.dataTransfer.files];
  renderFiles();
});

/* ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º */
function renderFiles() {
  if (files.length === 0) {
    fileBox.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“";
    return;
  }

  fileBox.innerHTML = files.map(f =>
    `<div class="fileItem">
      ğŸ“„ ${f.name} / ${f.type || "unknown"} / ${formatBytes(f.size)}
     </div>`
  ).join("");
}

/* å®¹é‡æ¸¬å®š */
document.getElementById("measureBtn").addEventListener("click", () => {
  if (files.length === 0) {
    sizeResult.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“";
    return;
  }
  const total = files.reduce((a,f)=>a+f.size,0);
  sizeResult.textContent = `åˆè¨ˆå®¹é‡ï¼š${formatBytes(total)}`;
});

/* pxã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
const pxRange = document.getElementById("pxRange");
const pxValue = document.getElementById("pxValue");
pxRange.addEventListener("input", () => {
  pxValue.textContent = pxRange.value;
});

/* åœ§ç¸® */
document.getElementById("compressBtn").addEventListener("click", async () => {
  compressResult.innerHTML = "";

  const images = files.filter(f => f.type.startsWith("image/"));
  if (images.length === 0) {
    compressResult.textContent = "ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“";
    return;
  }

  for (const file of images) {
    const { blob, url } = await compressImage(file, Number(pxRange.value));

    const row = document.createElement("div");
    row.className = "previewRow";

    row.innerHTML = `
      <div class="imageBox">
        <div>å…ƒç”»åƒ</div>
        <img src="${URL.createObjectURL(file)}">
        <small>${formatBytes(file.size)}</small>
      </div>

      <div class="imageBox">
        <div>åœ§ç¸®å¾Œ</div>
        <img src="${url}">
        <small>${formatBytes(blob.size)}</small><br>
        <a href="${url}" download="compressed.jpg">
          <button>ä¿å­˜</button>
        </a>
      </div>
    `;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    row.querySelectorAll("img").forEach(img => {
      img.onclick = () => {
        modalImg.src = img.src;
        modal.style.display = "flex";
      };
    });

    compressResult.appendChild(row);
  }
});

/* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ */
modal.addEventListener("click", () => {
  modal.style.display = "none";
});

/* åœ§ç¸®å‡¦ç† */
function compressImage(file, targetWidth) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const scale = targetWidth / img.width;
      const canvas = document.createElement("canvas");
      canvas.width = targetWidth;
      canvas.height = img.height * scale;

      canvas.getContext("2d").drawImage(img,0,0,canvas.width,canvas.height);

      canvas.toBlob(blob => {
        resolve({ blob, url: URL.createObjectURL(blob) });
      }, "image/jpeg", 0.9);
    };
    img.src = URL.createObjectURL(file);
  });
}

function formatBytes(bytes) {
  const units = ["B","KB","MB","GB","TB","PB"];
  let i=0;
  while(bytes>=1024 && i<units.length-1){bytes/=1024;i++;}
  return bytes.toFixed(2)+" "+units[i];
}
</script>

</body>
</html>
