<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ローン計算機</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  font-family: system-ui, sans-serif;
  font-size: 14px;
  overflow: hidden;
}

.container {
  max-width: 900px;
  height: 100%;
  margin: auto;
  padding: 12px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

label {
  display: block;
  margin-bottom: 6px;
}

input {
  font-size: 14px;
  padding: 6px;
  width: 100%;
  box-sizing: border-box;
}

select {
  font-size: 14px;
  height: 102px;
  width: 100%;
  box-sizing: border-box;
}

button {
  font-size: 14px;
  height: 108px;
  width: 100%;
  margin-top: 6px;
  padding: 0;
  cursor: pointer;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: center;
}

.result {
  margin-top: 8px;
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
}

.result p {
  margin: 2px 0;
}

.chart-wrap {
  flex: 1 1 auto;
}

canvas {
  width: 100% !important;
  height: 100% !important;
}
</style>
</head>

<body>
<div class="container">
<h2>ローン返済シミュレーター</h2>

<label>
  借入金額（円）
  <input id="principal" type="text" inputmode="numeric">
</label>

<label>
  年利（%）
  <input id="rate" type="text" inputmode="decimal">
</label>

<label>
  返済期間（年）
  <input id="years" type="text" inputmode="numeric">
</label>

<label>
  返済方式
  <select id="method">
    <option value="equalPrincipal">元金均等</option>
    <option value="annuity">元利均等</option>
  </select>
</label>

<button id="calcBtn">計算する</button>

<div class="result">
  <p>月々の返済額：<span id="monthly"></span> 円</p>
  <p>総返済額：<span id="total"></span> 円</p>
  <p>利息累計：<span id="interest"></span> 円</p>
  <p>利息割合：<span id="ratio"></span> %</p>

  <div class="chart-wrap">
    <canvas id="chart"></canvas>
  </div>
</div>
</div>

<script>
function normalizeNumber(value) {
  return value
    .replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248))
    .replace(/[^\d.]/g, '');
}

const principalInput = document.getElementById('principal');
const rateInput = document.getElementById('rate');
const yearsInput = document.getElementById('years');
const methodSelect = document.getElementById('method');

const ctx = document.getElementById('chart').getContext('2d');
let chart = null;

document.getElementById('calcBtn').addEventListener('click', () => {
  const principal = Math.round(Number(normalizeNumber(principalInput.value)));
  const rate = Number(normalizeNumber(rateInput.value)) / 100 / 12;
  const months = Number(normalizeNumber(yearsInput.value)) * 12;
  const method = methodSelect.value;

  if (!principal || !months) return;

  let cumulativePayments = [];
  let cumulativeInterests = [];
  let remainingBalances = [];
  let monthlyPayments = [];   // ★ 追加

  let totalPaid = 0;
  let totalInterest = 0;
  let balance = principal;

  if (method === 'equalPrincipal') {
    const base = Math.floor(principal / months);
    for (let i = 0; i < months; i++) {
      const interest = Math.round(balance * rate);
      const payment = base + interest;
      balance -= base;

      totalPaid += payment;
      totalInterest += interest;

      monthlyPayments.push(payment);        // ★ 追加
      cumulativePayments.push(totalPaid);
      cumulativeInterests.push(totalInterest);
      remainingBalances.push(balance > 0 ? balance : 0);
    }
  } else {
    const payment = Math.round(
      principal * rate * Math.pow(1 + rate, months) /
      (Math.pow(1 + rate, months) - 1)
    );
    for (let i = 0; i < months; i++) {
      const interest = Math.round(balance * rate);
      const principalPart = payment - interest;
      balance -= principalPart;

      totalPaid += payment;
      totalInterest += interest;

      monthlyPayments.push(payment);        // ★ 追加
      cumulativePayments.push(totalPaid);
      cumulativeInterests.push(totalInterest);
      remainingBalances.push(balance > 0 ? balance : 0);
    }
  }

  monthly.textContent = monthlyPayments[0].toLocaleString();
  total.textContent = totalPaid.toLocaleString();
  interest.textContent = totalInterest.toLocaleString();
  ratio.textContent = ((totalInterest / totalPaid) * 100).toFixed(1);

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: cumulativePayments.map((_, i) => i + 1),
      datasets: [
        {
          label: '累計支払額（元金＋利息）',
          data: cumulativePayments,
          borderColor: 'blue',
          backgroundColor: 'rgba(0,0,255,0.1)',
          fill: true
        },
        {
          label: '利息累計',
          data: cumulativeInterests,
          borderColor: 'red',
          backgroundColor: 'rgba(255,0,0,0.1)',
          fill: true
        },
        {
          label: '残債',
          data: remainingBalances,
          borderColor: 'green',
          backgroundColor: 'rgba(0,128,0,0.1)',
          fill: true
        },
        {
          label: 'その月の返済額',
          data: monthlyPayments,
          borderColor: 'gold',
          backgroundColor: 'rgba(255,215,0,0.15)',
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          animation: false,
          mode: 'index',
          intersect: false
        },
        legend: { display: true }
      },
      interaction: {
        mode: 'index',
        intersect: false
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: '円' } },
        x: { title: { display: true, text: '月数' } }
      }
    }
  });
});
</script>
</body>
</html>
